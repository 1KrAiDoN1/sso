

# Сервис единого входа (SSO)

![Go](https://img.shields.io/badge/Go-1.21-00ADD8?style=for-the-badge&logo=go&logoColor=white)
![gRPC](https://img.shields.io/badge/gRPC-1.58-00ADEF?style=for-the-badge&logo=grpc&logoColor=white)
![PostgreSQL](https://img.shields.io/badge/PostgreSQL-15-316192?style=for-the-badge&logo=postgresql&logoColor=white)
![Docker](https://img.shields.io/badge/Docker-24.0-2496ED?style=for-the-badge&logo=docker&logoColor=white)
![Лицензия](https://img.shields.io/badge/лицензия-MIT-green?style=for-the-badge)


**Сервис единого входа (SSO)** — это надежная и безопасная система аутентификации, построенная с использованием Go, gRPC и PostgreSQL. Он предоставляет централизованное решение для аутентификации, позволяя пользователям регистрироваться, входить в систему и проверять права администратора в нескольких приложениях с помощью одного набора учетных данных. Используя современные технологии, такие как gRPC для эффективного взаимодействия, JWT для безопасной генерации токенов и PostgreSQL для постоянного хранения данных, этот сервис разработан с учетом масштабируемости, безопасности и удобства сопровождения.

Проект включает в себя обширные модульные тесты, поддержку Docker для бесшовного развертывания и детальное журналирование для эффективной отладки и мониторинга. Его модульная архитектура обеспечивает четкое разделение ответственности, что упрощает расширение и поддержку.

## Особенности

- **Аутентификация пользователей**: Регистрация и вход пользователей с использованием электронной почты и пароля.
- **Проверка роли администратора**: Проверка, имеет ли пользователь права администратора.
- **Генерация JWT-токенов**: Создание безопасных JWT-токенов с настраиваемым временем жизни (TTL).
- **gRPC API**: Высокопроизводительный API для взаимодействия между сервисами с использованием gRPC и Protocol Buffers.
- **Хранилище PostgreSQL**: Надежное хранилище для данных пользователей и приложений с поддержкой миграций.
- **Детальное журналирование**: Пользовательский логгер с цветным выводом на основе Zerolog для улучшенной отладки.
- **Модульные тесты**: Обширный набор тестов, охватывающий как успешные сценарии, так и граничные случаи.
- **Поддержка Docker**: Включает `Dockerfile` и `docker-compose.yaml` для легкой настройки и развертывания.
- **Конфигурация окружения**: Управление чувствительными настройками через файлы `.env` и YAML-конфигурации.
- **Миграции базы данных**: SQL-скрипты для инкрементального управления схемой.

## Структура проекта

Проект организован в модульные директории для улучшения поддерживаемости:

```
sso/
├── cmd/
│   └── sso/
│       └── main.go              # Точка входа приложения
├── internal/
│   ├── app/
│   │   ├── grpc/
│   │   │   └── app.go           # Настройка и управление жизненным циклом gRPC-сервера
│   │   └── app.go               # Логика инициализации приложения
│   ├── config/
│   │   ├── config.go            # Загрузка и парсинг конфигурации
│   │   ├── config.yaml          # Файл конфигурации сервера
│   │   └── local_tests.yaml     # Конфигурационный файл для тестов
│   ├── domain/
│   │   ├── models/
│   │   │   ├── app.go           # Определение модели приложения
│   │   │   └── user.go          # Определение модели пользователя
│   ├── grpc/
│   │   └── auth/
│   │       └── server.go        # Реализация gRPC-сервиса для аутентификации
│   ├── lib/
│   │   └── jwt/
│   │       └── jwt.go           # Логика генерации JWT-токенов
│   ├── services/
│   │   └── auth/
│   │       └── auth.go          # Бизнес-логика аутентификации
│   └── storage/
│       ├── postgres/
│       │   └── storage.go       # Реализация хранилища на PostgreSQL
│       └── storage.go           # Определения ошибок, связанных с хранилищем
├── migrations/
│   ├── 000001_init_db.down.sql  # Откат миграции для начальной схемы
│   ├── 000001_init_db.up.sql    # Миграция для начальной схемы
│   ├── 000002_add_is_admin_column.up.sql # Добавление колонки is_admin
│   └── 000003_add_app.up.sql    # Добавление таблицы apps
├── pkg/
│   └── logger/
│       └── logger.go            # Пользовательский логгер на основе Zerolog
├── protos/
│   └── sso/
│       └── v1/
│           └── auth.proto       # Определения Protocol Buffers для gRPC
├── tests/
│   ├── suite/
│   │   └── suite.go             # Настройка тестового набора для gRPC-тестирования
│   └── tests.go                 # Интеграционные тесты для аутентификации
├── .env.example                 # Пример файла переменных окружения
├── docker-compose.yml           # Конфигурация Docker Compose
├── Dockerfile                   # Dockerfile для контейнеризации
├── go.mod                       # Зависимости Go-модуля
└── go.sum                       # Контрольные суммы Go-модуля
```

## Архитектура

Сервис SSO использует слоистую архитектуру с четко разделенными обязанностями:

1. **gRPC-слой (`internal/grpc`)**: Обрабатывает входящие gRPC-запросы и направляет их к методам сервиса, реализуя интерфейс `AuthServer` из Protocol Buffers.
2. **Сервисный слой (`internal/services/auth`)**: Инкапсулирует логику аутентификации, включая регистрацию, вход и проверку администратора, взаимодействуя с хранилищем и утилитами JWT.
3. **Слой хранилища (`internal/storage/postgres`)**: Обрабатывает операции с базой данных PostgreSQL, предоставляя доступ к данным пользователей и приложений.
4. **Слой конфигурации (`internal/config`)**: Загружает настройки из YAML-файлов и переменных окружения, такие как учетные данные базы данных и конфигурации сервера.
5. **Журналирование (`pkg/logger`)**: Предоставляет пользовательский логгер с цветным выводом для отладки и мониторинга.
6. **Генерация JWT-токенов (`internal/lib/jwt`)**: Создает безопасные JWT-токены с claims пользователя и приложения.


## API

gRPC API определен в `protos/sso/v1/auth.proto` и включает:

- **Login**: Аутентифицирует пользователя и возвращает JWT-токен.
  - **Запрос**: `LoginRequest { email: string, password: string, app_id: int32 }`
  - **Ответ**: `LoginResponse { token: string }`
- **Register**: Регистрирует нового пользователя и возвращает его ID.
  - **Запрос**: `RegisterRequest { email: string, password: string }`
  - **Ответ**: `RegisterResponse { user_id: int64 }`
- **IsAdmin**: Проверяет статус администратора пользователя.
  - **Запрос**: `IsAdminRequest { user_id: int64 }`
  - **Ответ**: `IsAdminResponse { is_admin: bool }`

### Примеры gRPC-вызовов

Используйте `grpcurl` для взаимодействия с сервисом:

1. **Регистрация пользователя**:
   ```bash
   grpcurl -plaintext -d '{"email": "user@example.com", "password": "password123"}' localhost:4404 sso.v1.Auth/Register
   ```
2. **Вход**:
   ```bash
   grpcurl -plaintext -d '{"email": "user@example.com", "password": "password123", "app_id": 1}' localhost:4404 sso.v1.Auth/Login
   ```
3. **Проверка статуса администратора**:
   ```bash
   grpcurl -plaintext -d '{"user_id": 1}' localhost:4404 sso.v1.Auth/IsAdmin
   ```

## Зависимости

Ключевые зависимости из `go.mod`:
- **gRPC**: `google.golang.org/grpc`
- **Драйвер PostgreSQL**: `github.com/jackc/pgx/v5`
- **JWT**: `github.com/golang-jwt/jwt/v5`
- **bcrypt**: `golang.org/x/crypto/bcrypt`
- **Zerolog**: `github.com/rs/zerolog`
- **Godotenv**: `github.com/joho/godotenv`
- **Gofakeit**: `github.com/brianvoe/gofakeit/v6` (для тестов)
- **Testify**: `github.com/stretchr/testify` (для тестов)

## Настройка и установка

### Требования
- Go 1.21+
- PostgreSQL 15+
- Docker (опционально)

### Шаги
1. **Клонируйте репозиторий**:
   ```bash
   git clone <url-репозитория>
   cd sso
   ```
2. **Настройте переменные окружения**:
   ```bash
   cp .env.example .env
   ```
   Отредактируйте `.env` с вашими учетными данными базы данных.

3. **Сборка и запуск**:
   ```bash
   make docker-build

   make docker-up
   ```
4. **Доступ**: Доступно по адресу `localhost:4404`.

## Тестирование

Тесты в `/tests` охватывают:
- Успешные сценарии (регистрация, вход, проверка токена).
- Граничные случаи (дублирующаяся регистрация, неверные учетные данные).

Запуск тестов:
```bash
go test ./tests -v
```


